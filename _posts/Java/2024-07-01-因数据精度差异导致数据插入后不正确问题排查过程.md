---
layout: post
title:  "因数据精度差异导致数据插入后不正确问题排查过程"
date:   2024-06-18 20:01:00 +0800
categories: Java
---
### 问题现象
在最近的开发过程中发现了一个数据库中存储的时间总会比接口调用的时间晚一天的情况。比如，接口调用传递的时间是6月30日，而入库后在查询出来的时间是7月1日。

### 排查过程
* 代码逻辑错误

首先考虑的是接口的逻辑层中是否因为疏忽导致错误将调用方传递过来的时间修改了。经过排查并未发现此类问题。在出现问题的这个接口中，为了满足特定的业务场景会将客户端传递的日期精确化。比如客户端传递的是6月30日，接口逻辑会将这个时间精确到6月30日的23点59分59秒999毫秒（就是这个毫秒出的事，见后续介绍）。

* 时区相关

其次考虑的是不是时区相关问题导致的。因为数据库字段使用的是datetime类型，虽然这个类型本身并不包括时区信息，但如果应用连接数据库时使用的时区与应用中生成Date类型数据时使用的时区不一致，还是会出现一些问题的。但经过排查并未发现连接配置上有什么问题。

* 数据精度类型

最后能够排查的方面只能是数据精度的问题了。因为这个数据从调用方到应用服务最后再到数据库中涉及了多套不同的环境。如果其中一方在数据精度上没有对齐，那都有可能存在问题。先从接口调用和应用查起，通过抓包和代码断点并未发现问题。在将数据插入到数据库之前一直都是正常的。接着是排查数据库，数据库这里使用的是Mysql 8，字段的数据类型是datetime，其默认是精确到秒，除非在数据库定义语句中明确了毫秒的精度。前文提到，在接口逻辑中会将调用方传过来的日期精确化，拼接上时分秒毫秒信息。因此大胆的猜想会不会是因为应用中设置了毫秒，而数据库精度中没有毫秒导致的。通过尝试将应用服务代码中设置日期毫秒值的逻辑删除后在尝试调用接口，发现问题已经不复现了。到此问题得到了解决。

### 结论
由于在应用服务层给日期数据设置了毫秒单位的值，而数据库中的字段定义中没有设定毫秒的精度，导致数据库在将数据存储表中时对数据进行了四舍五入。例如会将6月30日23点59分59秒999毫秒的Date数据直接四舍五入为7月1日。

今后，在不同环境间传递数据时一定要特别留意数据类型精度上的差异，在应对精度差异时其采取的措施有可能是直接舍去或者是四舍五入。在使用时一定要特别留心不同环境对于此类问题的具体处理形式。
